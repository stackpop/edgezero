# This manifest describes the shared EdgeZero application and its adapter-specific configurations.

[app]
name = "app-demo"
middleware = ["edgezero_core::middleware::RequestLogger"]
version = "0.1.0"
kind = "http"
entry = "crates/app-demo-core"

[[triggers.http]]
id = "root"
path = "/"
methods = ["GET"]
handler = "app_demo_core::handlers::root"
adapters = ["axum", "cloudflare", "fastly", "spin"]
description = "Default health-check endpoint"

[[triggers.http]]
id = "echo"
path = "/echo/{name}"
methods = ["GET"]
handler = "app_demo_core::handlers::echo"
adapters = ["axum", "cloudflare", "fastly", "spin"]

[[triggers.http]]
id = "stream"
path = "/stream"
methods = ["GET"]
handler = "app_demo_core::handlers::stream"
adapters = ["axum", "cloudflare", "fastly", "spin"]
body-mode = "stream"

[[triggers.http]]
id = "headers"
path = "/headers"
methods = ["GET"]
handler = "app_demo_core::handlers::headers"
adapters = ["axum", "cloudflare", "fastly", "spin"]

[[triggers.http]]
id = "echo_json"
path = "/echo"
methods = ["POST"]
handler = "app_demo_core::handlers::echo_json"
adapters = ["axum", "cloudflare", "fastly", "spin"]


[[triggers.http]]
id = "proxy_demo"
path = "/proxy/{*rest}"
methods = ["GET", "POST"]
handler = "app_demo_core::handlers::proxy_demo"
adapters = ["axum", "cloudflare", "fastly", "spin"]

# [environment]
#
# [[environment.variables]]
# name = "API_BASE_URL"
# description = "Base URL for upstream API calls"
# env = "API_BASE_URL"
# value = "https://example.com/api"
#
# [[environment.secrets]]
# name = "API_TOKEN"
# description = "Secret token used when calling the upstream API"
# adapters = ["axum", "cloudflare", "fastly"]
# env = "API_TOKEN"

[adapters.axum.adapter]
crate = "crates/app-demo-adapter-axum"
manifest = "crates/app-demo-adapter-axum/axum.toml"

[adapters.axum.build]
target = "native"
profile = "dev"

[adapters.axum.commands]
build = "cargo build -p app-demo-adapter-axum"
deploy = "# configure deployment for Axum"
serve = "cargo run -p app-demo-adapter-axum"

[adapters.axum.logging]
level = "info"
echo_stdout = true

[adapters.cloudflare.adapter]
crate = "crates/app-demo-adapter-cloudflare"
manifest = "crates/app-demo-adapter-cloudflare/wrangler.toml"

[adapters.cloudflare.build]
target = "wasm32-unknown-unknown"
profile = "release"
features = ["cloudflare"]

[adapters.cloudflare.commands]
build = "wrangler build --cwd crates/app-demo-adapter-cloudflare"
deploy = "wrangler deploy --cwd crates/app-demo-adapter-cloudflare"
serve = "wrangler dev --cwd crates/app-demo-adapter-cloudflare"

[adapters.cloudflare.logging]
level = "info"

[adapters.fastly.adapter]
crate = "crates/app-demo-adapter-fastly"
manifest = "crates/app-demo-adapter-fastly/fastly.toml"

[adapters.fastly.build]
target = "wasm32-wasip1"
profile = "release"
features = ["fastly"]

[adapters.fastly.commands]
build = "fastly compute build -C crates/app-demo-adapter-fastly"
deploy = "fastly compute deploy -C crates/app-demo-adapter-fastly"
serve = "fastly compute serve -C crates/app-demo-adapter-fastly"


[adapters.fastly.logging]
endpoint = "app_demo_log"
level = "info"
echo_stdout = true

[adapters.spin.adapter]
crate = "crates/app-demo-adapter-spin"
manifest = "crates/app-demo-adapter-spin/spin.toml"

[adapters.spin.build]
target = "wasm32-wasip1"
profile = "release"
features = ["spin"]

[adapters.spin.commands]
build = "cargo build --target wasm32-wasip1 --release -p app-demo-adapter-spin"
deploy = "spin deploy --from crates/app-demo-adapter-spin"
serve = "spin up --from crates/app-demo-adapter-spin"

[adapters.spin.logging]
level = "info"
